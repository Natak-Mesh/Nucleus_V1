#!/bin/bash
                                                                                                          

#       ..        .....        ...       
#       ....     ......       ....      
#       .......... ...       .....       
#       ........    ..      ......       
#       ......      ..     .......       
#       .....       ...  .........       
#       ....        .....     ....      
#       ...         ....        ..   

#############################################
#        N A T A K   -   Nucleus OS v2.0    #
#                                           #
#      Configuration File Generation        #
#############################################


# Source configuration
source /etc/nucleus/mesh.conf

# Calculate frequency from channel (2.4GHz)
MESH_FREQ=$((2407 + ($MESH_CHANNEL * 5)))

# Generate wlan1 network config
cat > /etc/systemd/network/10-wlan1.network <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: MESH_IP
# ============================================================

[Match]
Name=wlan1

[Network]
Address=${MESH_IP}/24
ConfigureWithoutCarrier=yes
EOF

# Generate br-lan network config
cat > /etc/systemd/network/21-brlan.network <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: BR_LAN_IP, BR_LAN_IPV6_LL, MESH_IP
# ============================================================

[Match]
Name=br-lan

[Network]
Address=${BR_LAN_IP}/24
Address=${BR_LAN_IPV6_LL}/64
DHCPServer=yes

[DHCPServer]
PoolOffset=10
PoolSize=50
EmitDNS=yes
DNS=${MESH_IP}
EOF

# Generate hostapd config
cat > /etc/hostapd/hostapd.conf <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: AP_NAME, AP_CHANNEL, AP_PASSWORD
# ============================================================

interface=wlan0
ssid=$AP_NAME
hw_mode=g
channel=$AP_CHANNEL
auth_algs=1
wmm_enabled=1
wpa=2
wpa_passphrase=$AP_PASSWORD
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOF

# Generate wpa_supplicant config
cat > /etc/wpa_supplicant/wpa_supplicant-wlan1-encrypt.conf <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: MESH_NAME, MESH_CHANNEL, MESH_FREQ, MESH_PASSWORD
# ============================================================

ctrl_interface=/var/run/wpa_supplicant
update_config=1
ap_scan=0
country=US

network={
    ssid="$MESH_NAME"
    mode=5
    frequency=$MESH_FREQ
    key_mgmt=SAE
    psk="$MESH_PASSWORD"
    mesh_fwding=0
    ieee80211w=2
}
EOF

echo "Configuration files generated successfully."
