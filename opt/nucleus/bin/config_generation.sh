#!/bin/bash
                                                                                                          

#       ..        .....        ...       
#       ....     ......       ....      
#       .......... ...       .....       
#       ........    ..      ......       
#       ......      ..     .......       
#       .....       ...  .........       
#       ....        .....     ....      
#       ...         ....        ..   

#############################################
#        N A T A K   -   Nucleus OS v2.0    #
#                                           #
#      Configuration File Generation        #
#############################################


# Source configuration
source /etc/nucleus/mesh.conf

# Calculate frequency from channel (2.4GHz)
MESH_FREQ=$((2407 + ($MESH_CHANNEL * 5)))

# Calculate subnets from IP addresses
MESH_SUBNET=$(echo $MESH_IP | cut -d'.' -f1-3).0/24
BR_LAN_SUBNET=$(echo $BR_LAN_IP | cut -d'.' -f1-3).0/24
ETH0_SUBNET=$(echo $ETH0_STATIC_IP | cut -d'.' -f1-3).0/24

# Generate eth0 network config
cat > /etc/systemd/network/40-eth0-lan.network <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: ETH0_STATIC_IP, ETH0_DHCP_POOL_OFFSET, ETH0_DHCP_POOL_SIZE
# ============================================================
# eth0 AUTO-SWITCH CONFIGURATION
# WAN Mode: When DHCP available (plugged into router)
# LAN Mode: When no DHCP (plugged into device/laptop)
# ============================================================

[Match]
Name=eth0

[Network]
# Try DHCP first (WAN mode)
DHCP=ipv4

# Fallback to IPv4LL when DHCP fails (triggers LAN mode)
IPv4LL=yes

# Static IP for LAN gateway mode
Address=${ETH0_STATIC_IP}/24

# Always enable forwarding between eth0 and mesh interfaces
IPv4Forwarding=yes

# WAN mode gets lower metric (preferred)
RouteMetric=100

# DHCPServer configuration (controlled by dispatcher scripts)
# Disabled by default - enabled by degraded.d script in LAN mode
DHCPServer=no

[DHCPServer]
# DHCP pool configuration for LAN mode
PoolOffset=${ETH0_DHCP_POOL_OFFSET}
PoolSize=${ETH0_DHCP_POOL_SIZE}
EmitDNS=no
DefaultLeaseTimeSec=3600
MaxLeaseTimeSec=7200
EOF

# Generate wlan1 network config
cat > /etc/systemd/network/10-wlan1.network <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: MESH_IP, MESH_IPV6_LL
# ============================================================

[Match]
Name=wlan1

[Network]
Address=${MESH_IP}/24
Address=${MESH_IPV6_LL}/64
LinkLocalAddressing=no
IPv6AcceptRA=no
ConfigureWithoutCarrier=yes
EOF

# Generate br-lan network config
cat > /etc/systemd/network/21-brlan.network <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: BR_LAN_IP, BR_LAN_IPV6_LL, MESH_IP
# ============================================================

[Match]
Name=br-lan

[Network]
Address=${BR_LAN_IP}/24
Address=${BR_LAN_IPV6_LL}/64
LinkLocalAddressing=no
IPv6AcceptRA=no
DHCPServer=yes

[DHCPServer]
PoolOffset=10
PoolSize=50
EmitDNS=yes
DNS=${MESH_IP}
EOF

# Generate hostapd config
cat > /etc/hostapd/hostapd.conf <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: AP_NAME, AP_CHANNEL, AP_PASSWORD
# ============================================================

interface=wlan0
ssid=$AP_NAME
hw_mode=g
channel=$AP_CHANNEL
auth_algs=1
wmm_enabled=1
wpa=2
wpa_passphrase=$AP_PASSWORD
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
EOF

# Generate wpa_supplicant config
cat > /etc/wpa_supplicant/wpa_supplicant-wlan1-encrypt.conf <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: MESH_NAME, MESH_CHANNEL, MESH_FREQ, MESH_PASSWORD
# ============================================================

ctrl_interface=/var/run/wpa_supplicant
update_config=1
ap_scan=0
country=US

network={
    ssid="$MESH_NAME"
    mode=5
    frequency=$MESH_FREQ
    key_mgmt=SAE
    psk="$MESH_PASSWORD"
    mesh_fwding=0
    ieee80211w=2
}
EOF

# Generate babeld config
cat > /etc/babeld.conf <<EOF
# ============================================================
# This file is dynamically generated by config_generation.sh
# Do not edit manually - changes will be overwritten
# Configuration variables sourced from /etc/nucleus/mesh.conf
# Variables used: MESH_SUBNET, BR_LAN_SUBNET
# ============================================================

# Babeld Routing Configuration for Natak Mesh
# This configuration enables proper route redistribution across the mesh network

# Kernel route installation
import-table 254
export-table 254

# Local monitoring interface (read-only)
local-port 33123

# Wireless mesh interface (wlan1)
interface wlan1 type wireless link-quality true split-horizon false rxcost 256 hello-interval 4 update-interval 16

# Wired bridge interface (br-lan)
interface br-lan type wired rxcost 96 hello-interval 4

# Redistribute local mesh network
redistribute ip ${MESH_SUBNET} allow

# Redistribute br-lan network
redistribute ip ${BR_LAN_SUBNET} allow

# Block default local address /32 export (must come after allow rules)
redistribute local deny

# Default deny to prevent redistributing unwanted routes
redistribute deny
EOF

echo "Configuration files generated successfully."
