<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Natak Mesh - Wi-Fi Channel Scan</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .scan-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .scan-controls {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333333;
            margin-bottom: 20px;
        }

        .scan-controls h2 {
            margin-top: 0;
            color: #ffffff;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .control-group label {
            font-weight: bold;
            color: #a0a0a0;
        }

        .control-group select {
            padding: 8px;
            border: 1px solid #333333;
            border-radius: 4px;
            font-size: 14px;
            background: #1a1a1a;
            color: #ffffff;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary {
            background-color: #4a6fff;
            color: #ffffff;
        }

        .btn-primary:hover {
            opacity: 0.8;
        }

        .btn-primary:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-success {
            background-color: #00ff88;
            color: #1a1a1a;
        }

        .btn-success:hover {
            opacity: 0.8;
        }

        .scan-status {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333333;
            margin-bottom: 20px;
            display: none;
        }

        .scan-status.active {
            display: block;
        }

        .scan-status h2 {
            color: #ffffff;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1a1a1a;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #333333;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a6fff, #0099ff);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-weight: bold;
        }

        .scan-results {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #333333;
            display: none;
        }

        .scan-results.active {
            display: block;
        }

        .scan-results h2 {
            color: #ffffff;
        }

        .results-summary {
            margin-bottom: 20px;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 4px;
            border: 1px solid #333333;
        }

        .results-summary h3 {
            margin-top: 0;
            color: #ffffff;
        }

        .results-actions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #333333;
            text-align: center;
        }

        .best-channels {
            display: flex;
            gap: 15px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .best-channel {
            padding: 10px 20px;
            background: #00ff88;
            color: #1a1a1a;
            border-radius: 4px;
            font-weight: bold;
        }

        .channel-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .channel-table th,
        .channel-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333333;
            color: #ffffff;
        }

        .channel-table th {
            background: #1a1a1a;
            font-weight: bold;
            color: #a0a0a0;
        }

        .channel-table tr:hover {
            background: #3a3a3a;
        }

        .channel-table tr.recommended {
            background: #2a3a2a;
        }

        .channel-table tr.recommended:hover {
            background: #3a4a3a;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-EMPTY {
            background: #00ff88;
            color: #1a1a1a;
        }

        .status-EXCELLENT {
            background: #00d4ff;
            color: #1a1a1a;
        }

        .status-GOOD {
            background: #ffaa00;
            color: #1a1a1a;
        }

        .status-MODERATE {
            background: #ff8800;
            color: #1a1a1a;
        }

        .status-CONGESTED {
            background: #ff4444;
            color: #ffffff;
        }

        .network-list {
            font-size: 12px;
            color: #a0a0a0;
        }

        .error-message {
            background: #3a2020;
            color: #ff4444;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #ff4444;
        }

        .warning-box {
            background: #3a3020;
            border: 1px solid #ffaa00;
            color: #ffaa00;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .warning-box strong {
            display: block;
            margin-bottom: 5px;
        }

        #status-text {
            color: #a0a0a0;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='images/NatakMeshsecondary-overlay.png') }}" alt="Natak Mesh" class="logo">
        <nav>
            <button class="nav-btn" onclick="window.location.href='/'">Network Monitor</button>
            <button class="nav-btn" onclick="window.location.href='/config'">Configuration</button>
        </nav>
    </header>

    <main>
        <div class="scan-container">
            <h1>Wi-Fi Channel Scan</h1>

            <div class="warning-box">
                <strong>⚠️ Warning:</strong>
                Scanning will temporarily disconnect the mesh network for the duration of the scan. 
                Mesh services will automatically restart after the scan completes.
            </div>

            <div class="scan-controls">
                <h2>Start Channel Scan</h2>
                <div class="control-group">
                    <label for="duration">Scan Duration:</label>
                    <select id="duration">
                        <option value="30">30 seconds</option>
                        <option value="60" selected>60 seconds (recommended)</option>
                        <option value="90">90 seconds</option>
                        <option value="120">2 minutes</option>
                    </select>
                    <button id="start-scan-btn" class="btn btn-primary" onclick="startScan()">Start Scan</button>
                </div>
            </div>

            <div id="scan-status" class="scan-status">
                <h2>Scanning in Progress...</h2>
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%;">0%</div>
                </div>
                <p id="status-text">Initializing scan...</p>
            </div>

            <div id="scan-results" class="scan-results">
                <h2>Scan Results</h2>
                <div class="results-summary">
                    <h3>Recommended Channels (Non-overlapping: 1, 6, 11)</h3>
                    <div id="best-channels" class="best-channels"></div>
                </div>
                <table class="channel-table">
                    <thead>
                        <tr>
                            <th>Channel</th>
                            <th>Frequency</th>
                            <th>Networks</th>
                            <th>Congestion Score</th>
                            <th>Status</th>
                            <th>Detected Networks</th>
                        </tr>
                    </thead>
                    <tbody id="results-body">
                    </tbody>
                </table>
                <div class="results-actions">
                    <button id="restart-mesh-btn" class="btn btn-success" onclick="restartMesh()">Restart Mesh Services</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const WIFI_CHANNELS = {
            1: 2412, 2: 2417, 3: 2422, 4: 2427, 5: 2432, 6: 2437,
            7: 2442, 8: 2447, 9: 2452, 10: 2457, 11: 2462, 12: 2467, 13: 2472, 14: 2484
        };

        let statusInterval = null;

        async function startScan() {
            const duration = parseInt(document.getElementById('duration').value);
            const startBtn = document.getElementById('start-scan-btn');
            
            // Disable button
            startBtn.disabled = true;
            
            // Hide results, show status
            document.getElementById('scan-results').classList.remove('active');
            document.getElementById('scan-status').classList.add('active');
            
            try {
                const response = await fetch('/api/channel-scan/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duration: duration })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start scan');
                }
                
                // Start polling for status
                statusInterval = setInterval(checkStatus, 1000);
                
            } catch (error) {
                alert('Error starting scan: ' + error.message);
                startBtn.disabled = false;
                document.getElementById('scan-status').classList.remove('active');
            }
        }

        async function checkStatus() {
            try {
                const response = await fetch('/api/channel-scan/status');
                const data = await response.json();
                
                const progressFill = document.getElementById('progress-fill');
                const statusText = document.getElementById('status-text');
                
                progressFill.style.width = data.progress + '%';
                progressFill.textContent = data.progress + '%';
                
                if (data.status === 'running') {
                    statusText.textContent = `Scanning... ${data.remaining} seconds remaining`;
                } else if (data.status === 'complete') {
                    clearInterval(statusInterval);
                    statusText.textContent = 'Scan complete! Loading results...';
                    setTimeout(loadResults, 500);
                } else if (data.status === 'error') {
                    clearInterval(statusInterval);
                    statusText.innerHTML = '<div class="error-message">Scan failed: ' + (data.error || 'Unknown error') + '</div>';
                    document.getElementById('start-scan-btn').disabled = false;
                }
                
            } catch (error) {
                console.error('Error checking status:', error);
            }
        }

        async function loadResults() {
            try {
                const response = await fetch('/api/channel-scan/results');
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load results');
                }
                
                displayResults(data);
                
                // Hide status, show results
                document.getElementById('scan-status').classList.remove('active');
                document.getElementById('scan-results').classList.add('active');
                
                // Re-enable button
                document.getElementById('start-scan-btn').disabled = false;
                
            } catch (error) {
                alert('Error loading results: ' + error.message);
                document.getElementById('start-scan-btn').disabled = false;
                document.getElementById('scan-status').classList.remove('active');
            }
        }

        function displayResults(data) {
            // Display best channels
            const bestChannelsDiv = document.getElementById('best-channels');
            bestChannelsDiv.innerHTML = data.best_channels.map(ch => 
                `<div class="best-channel">Channel ${ch.channel} (${ch.status})</div>`
            ).join('');
            
            // Display all channels in table
            const tbody = document.getElementById('results-body');
            tbody.innerHTML = data.all_channels.map(ch => {
                const isRecommended = [1, 6, 11].includes(ch.channel);
                const networkNames = ch.networks.map(n => n.essid || n.bssid).join(', ');
                
                return `
                    <tr class="${isRecommended ? 'recommended' : ''}">
                        <td><strong>Channel ${ch.channel}${isRecommended ? ' ⭐' : ''}</strong></td>
                        <td>${WIFI_CHANNELS[ch.channel]} MHz</td>
                        <td>${ch.network_count}</td>
                        <td>${ch.score}</td>
                        <td><span class="status-badge status-${ch.status}">${ch.status}</span></td>
                        <td class="network-list">${networkNames || 'None detected'}</td>
                    </tr>
                `;
            }).join('');
        }

        async function restartMesh() {
            const restartBtn = document.getElementById('restart-mesh-btn');
            
            if (!confirm('Restart mesh services now? This will briefly disconnect the mesh network.')) {
                return;
            }
            
            restartBtn.disabled = true;
            restartBtn.textContent = 'Restarting...';
            
            try {
                const response = await fetch('/api/restart-mesh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to restart mesh services');
                }
                
                alert('Mesh services restarted successfully!');
                restartBtn.textContent = 'Restart Mesh Services';
                restartBtn.disabled = false;
                
            } catch (error) {
                alert('Error restarting mesh: ' + error.message);
                restartBtn.textContent = 'Restart Mesh Services';
                restartBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
