#!/bin/bash
# ===============================================================
# LAN MODE DISPATCHER SCRIPT
# Triggered when eth0 falls back to IPv4LL (DHCP failed - device/laptop connected)
# ===============================================================

IFACE=$1
STATE=$2

# Only act on eth0 in degraded state
if [ "$IFACE" != "eth0" ]; then
    exit 0
fi

# Source mesh configuration to get ETH0_STATIC_IP
source /etc/nucleus/mesh.conf

logger -t eth0-lan-mode "eth0 entered LAN mode (DHCP failed, IPv4LL fallback)"

# Enable DHCP server and add static IP via drop-in configuration
logger -t eth0-lan-mode "Enabling DHCP server and static IP ${ETH0_STATIC_IP}/24 on eth0"

# Create drop-in directory if it doesn't exist
mkdir -p /etc/systemd/network/40-eth0-lan.network.d

# Create drop-in file to enable DHCP server and add static IP
cat > /etc/systemd/network/40-eth0-lan.network.d/dhcp-server-enable.conf <<EOF
[Network]
DHCPServer=yes
Address=${ETH0_STATIC_IP}/24
EOF

# Reconfigure eth0 to apply the change
networkctl reconfigure eth0

logger -t eth0-lan-mode "LAN mode configuration complete - DHCP server active on ${ETH0_STATIC_IP}/24"
